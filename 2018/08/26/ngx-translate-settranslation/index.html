<!DOCTYPE html><html lang="zh-tw"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>[Angular] ngx-translate 的 setTranslation() 與一些眉角 | 歷史共業</title><meta name="description" content="[Angular] ngx-translate 的 setTranslation() 與一些眉角 - Ronnie Chang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/blog/atom.xml" title="歷史共業"></head><body><div class="wrap"><header><h1 class="branding"><a href="/blog/" title="歷史共業"><img class="logo-image" src="/blog/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/blog/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog/archives/" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog/tags/" target="_self">TAGS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://yuugou727.github.io/" target="_blank">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">[Angular] ngx-translate 的 setTranslation() 與一些眉角</h1><div class="post-info"><a></a>2018-08-26<span class="categories"><a class="post-category" href="/blog/categories/前端筆記/">前端筆記</a></span><ul class="tags"><li><a class="post-tag" href="/blog/tags/Angular/">Angular</a></li><li><a class="post-tag" href="/blog/tags/ngx-translate/">ngx-translate</a></li><li><a class="post-tag" href="/blog/tags/i18n/">i18n</a></li></ul></div><div class="post-content"><p>命運多舛，在當了幾個月待業廢物後，總算找到風氣跟待遇都不錯的新工作，<del>如果寫扣寫到懷疑人生就離職換工作吧</del>。也為了新工作開始學習 Angular，解開使用三大前端框架的成就，這次來記錄 Angular i18n 套件 <a href="http://www.ngx-translate.com/" target="_blank" rel="noopener">ngx-translate</a> 上所碰到的問題與解決方法。</p>
<a id="more"></a>
<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>主要是實務上需要使用到<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTranslation(lang: <span class="built_in">string</span>, translations: <span class="built_in">Object</span>, shouldMerge: <span class="built_in">boolean</span> = <span class="literal">false</span>)</span><br></pre></td></tr></table></figure></p>
<p>這個 method 時，所歸納的要點：</p>
<ul>
<li><code>setTranslation()</code> 第三個參數 <code>shouldMerge</code> 結果不符預期，使用 Lodash 的 <code>_.merge()</code> 自幹解決</li>
<li><code>setTranslation()</code> 一定要在 <code>use()</code> 與 <code>setDefaultLang()</code> 之前完成，否則會吃到舊的翻譯檔，也就是不會熱更新</li>
<li>由於 <code>setTranslation()</code> 沒有 return Observerble，因此用 <code>setTimeout(0)</code> 來實現第二點的非同步。</li>
</ul>
<h1 id="心路歷程"><a href="#心路歷程" class="headerlink" title="心路歷程"></a>心路歷程</h1><h2 id="基本設置"><a href="#基本設置" class="headerlink" title="基本設置"></a>基本設置</h2><p>用 Angular-cli 新建一個 project，照著 ngx-translate 文件 <code>npm install --save</code> 安裝 <code>@ngx-translate/core</code> 與 <code>@ngx-translate/http-loader</code> ，在 app,module.ts 裡接好 loader </p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpClientModule, HttpClient&#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TranslateModule, TranslateLoader &#125; <span class="keyword">from</span> <span class="string">'@ngx-translate/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TranslateHttpLoader &#125; <span class="keyword">from</span> <span class="string">'@ngx-translate/http-loader'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">HttpLoaderFactory</span>(<span class="params">http: HttpClient</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> TranslateHttpLoader(http);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    HttpClientModule,</span><br><span class="line">    TranslateModule.forRoot(&#123;</span><br><span class="line">      loader: &#123;</span><br><span class="line">        provide: TranslateLoader,</span><br><span class="line">        useFactory: HttpLoaderFactory,</span><br><span class="line">        deps: [HttpClient]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>
<p>寫兩份翻譯檔，放在 <code>src/assets/i18n/</code> 資料夾底下<br><figure class="highlight json"><figcaption><span>en.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"WELCOME_TO"</span>: <span class="string">"Welcome to"</span>,</span><br><span class="line">  <span class="attr">"SELECT_LANGUAGE"</span>: <span class="string">"Select a language"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight json"><figcaption><span>zh-TW.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"WELCOME_TO"</span>: <span class="string">"歡迎使用"</span>,</span><br><span class="line">  <span class="attr">"SELECT_LANGUAGE"</span>: <span class="string">"選擇語言"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 template 中寫個簡單的語言切換選單</p>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align:center"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;&#123; 'WELCOME_TO' | translate &#125;&#125; &#123;&#123; title &#125;&#125;!</span><br><span class="line">  <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"lang"</span>&gt;</span></span><br><span class="line">    &#123;&#123; 'SELECT_LANGUAGE' | translate &#125;&#125;:</span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> #<span class="attr">langSelect</span> <span class="attr">name</span>=<span class="string">"lang"</span> (<span class="attr">change</span>)=<span class="string">"translate.use(langSelect.value)"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> *<span class="attr">ngFor</span>=<span class="string">"let lang of translate.getLangs()"</span> [<span class="attr">value</span>]=<span class="string">"lang"</span></span></span><br><span class="line"><span class="tag">        [<span class="attr">selected</span>]=<span class="string">"lang === translate.currentLang"</span>&gt;</span>&#123;&#123; lang &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 constructor 中使用 TranslateService</p>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; TranslateService, LangChangeEvent &#125; <span class="keyword">from</span> <span class="string">'@ngx-translate/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  title = <span class="string">'ngx-translate'</span>;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> translate: TranslateService</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    translate.addLangs([<span class="string">'en'</span>, <span class="string">'zh-TW'</span>]);</span><br><span class="line">    translate.setDefaultLang(<span class="string">'en'</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>ng serve</code> 跑起來，就能看到我們簡單的 i18n 網頁</p>
<img src="/blog/2018/08/26/ngx-translate-settranslation/en.png">
<img src="/blog/2018/08/26/ngx-translate-settranslation/zh-TW.png">
<h2 id="語系判別-amp-儲存設定"><a href="#語系判別-amp-儲存設定" class="headerlink" title="語系判別 &amp; 儲存設定"></a>語系判別 &amp; 儲存設定</h2><p>我們也能將選取的語言值儲存到 <code>localStorage</code>，下次開啟網頁時就能沿用，並使用 <code>getBrowserCultureLang()</code> 做預設 fallback，改完的 constructor 長這樣：</p>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">translate.addLangs([<span class="string">'en'</span>, <span class="string">'zh-TW'</span>]);</span><br><span class="line">translate.onLangChange.subscribe(<span class="function">(<span class="params">event: LangChangeEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;lang&#125; = event;</span><br><span class="line">  localStorage.setItem(<span class="string">'useLang'</span>, lang);</span><br><span class="line">&#125;);</span><br><span class="line">translate.setDefaultLang(<span class="string">'en'</span>);</span><br><span class="line"><span class="keyword">const</span> useLang = localStorage.getItem(<span class="string">'useLang'</span>);</span><br><span class="line"><span class="keyword">if</span> (useLang) &#123;</span><br><span class="line">  translate.use(useLang);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> browserLang = translate.getBrowserCultureLang();</span><br><span class="line">  translate.use( translate.langs.includes(browserLang) ? browserLang : <span class="string">'en'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Merge-額外的翻譯"><a href="#Merge-額外的翻譯" class="headerlink" title="Merge 額外的翻譯"></a>Merge 額外的翻譯</h2><p>真正的需求來了，如果想將選單裡的「en」、「zh-TW」也翻成「English」與「正體中文」：</p>
<figure class="highlight html"><figcaption><span>app.component.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">option</span> *<span class="attr">ngFor</span>=<span class="string">"let lang of translate.getLangs()"</span> [<span class="attr">value</span>]=<span class="string">"lang"</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">selected</span>]=<span class="string">"lang === translate.currentLang"</span>&gt;</span>&#123;&#123; lang  | translate &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>不想把翻譯重複寫在 json 裡，另外 merge key-value 進去可以嗎？看文件似乎使用 <code>setTranslate()</code> 並設定第三個參數為 <code>true</code> 就能達到我們要的結果</p>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">  translate.onLangChange.subscribe(<span class="function">(<span class="params">event: LangChangeEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;lang&#125; = event;</span><br><span class="line">    localStorage.setItem(<span class="string">'useLang'</span>, lang);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> lang of translate.getLangs() ) &#123;</span><br><span class="line">      translate.setTranslation(lang, &#123;</span><br><span class="line">        <span class="string">'en'</span>: <span class="string">'English'</span>,</span><br><span class="line">        <span class="string">'zh-TW'</span>: <span class="string">'正體中文'</span></span><br><span class="line">      &#125;, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>實際上卻不是這樣…</p>
<img src="/blog/2018/08/26/ngx-translate-settranslation/failed.png">
<p>原有的翻譯不見了，只剩下選單的翻譯，這行為看起來是 replace 而非 merge，<del>文件居然陰我！？</del> <a href="https://github.com/ngx-translate/core/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+is%3Aopen+setTranslation" target="_blank" rel="noopener">查了 Github 的 issue </a>發現一堆人發了類似問題，也都沒有回應根本被放生WTF…</p>
<img src="https://media.giphy.com/media/aZ3LDBs1ExsE8/giphy.gif">
<p>山不轉路轉，只要直接給它 merge 好的翻譯就可以了吧？因此把 Lodash 拉進來改寫…</p>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; merge &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> lang of translate.getLangs() ) &#123;</span><br><span class="line">        <span class="keyword">const</span> json = <span class="built_in">require</span>(<span class="string">`../assets/i18n/<span class="subst">$&#123;lang&#125;</span>.json`</span>);</span><br><span class="line">        <span class="keyword">const</span> mergedLocale = merge(json, &#123;</span><br><span class="line">          <span class="string">'en'</span>: <span class="string">'English'</span>,</span><br><span class="line">          <span class="string">'zh-TW'</span>: <span class="string">'正體中文'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        translate.setTranslation(lang, mergedLocale);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="先後順序"><a href="#先後順序" class="headerlink" title="先後順序"></a>先後順序</h2><p> merge 後的翻譯 log 出來是正確的，結果只有中文頁 OK 但英文頁沒翻譯到選單？撞牆了一段時間才發現順序的重要性： <strong>必須先執行完 <code>setTranslation()</code>，再執行 <code>setDefaultLang()</code> 與 <code>use()</code> </strong> 。由於 <code>setTranslation()</code> 並沒有回傳值或是 Observerble，只好利用 JS 本身的 Queue：將 <code>setDefaultLang()</code> 與 <code>use()</code> 包在 <code>setTimeout(0)</code> 裡面，就能保證非同步順序：</p>
<figure class="highlight ts"><figcaption><span>app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">translate.addLangs([<span class="string">'en'</span>, <span class="string">'zh-TW'</span>]);</span><br><span class="line">translate.onLangChange.subscribe(<span class="function">(<span class="params">event: LangChangeEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;lang&#125; = event;</span><br><span class="line">  localStorage.setItem(<span class="string">'useLang'</span>, lang);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> lang of translate.getLangs() ) &#123;</span><br><span class="line">    <span class="keyword">const</span> json = <span class="built_in">require</span>(<span class="string">`../assets/i18n/<span class="subst">$&#123;lang&#125;</span>.json`</span>);</span><br><span class="line">    <span class="keyword">const</span> mergedLocale = merge(json, &#123;</span><br><span class="line">      <span class="string">'en'</span>: <span class="string">'English'</span>,</span><br><span class="line">      <span class="string">'zh-TW'</span>: <span class="string">'正體中文'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    translate.setTranslation(lang, mergedLocale);</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  translate.setDefaultLang(<span class="string">'en'</span>);</span><br><span class="line">  <span class="keyword">const</span> useLang = localStorage.getItem(<span class="string">'useLang'</span>);</span><br><span class="line">  <span class="keyword">if</span> (useLang) &#123;</span><br><span class="line">    translate.use(useLang);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> browserLang = translate.getBrowserCultureLang();</span><br><span class="line">    translate.use( translate.langs.includes(browserLang) ? browserLang : <span class="string">'en'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>總算，整頁與選單都能正確翻譯了</p>
<img src="/blog/2018/08/26/ngx-translate-settranslation/success.png">
<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>這麼長一串有點像幫第三方擦屁股，不確定 <code>setTranslation()</code> 裡面是不是有讓 <code>TranslateService</code> subscribe 觸發翻譯更新，文件也沒提到多少細節，還是呼籲大家慎選第三方 library 。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://github.com/ngx-translate/core" target="_blank" rel="noopener">https://github.com/ngx-translate/core</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/blog/2018/09/15/msi-gs60-win10-gestures/">上一篇</a><a class="next" href="/blog/2018/04/09/webpack-vue-dynamic-assets/">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'yuugou727';
var disqus_config = function () {
    this.page.url = 'https://yuugou727.github.io/blog/2018/08/26/ngx-translate-settranslation/';
    this.page.identifier = '2018/08/26/ngx-translate-settranslation/';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//' + disqus_shortname  + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', + new Date());
    (d.head || d.body).appendChild(s);
})();</script><div class="copyright"><p>&copy; 2017 - 2018 <a href="https://yuugou727.github.io/">Ronnie Chang</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/yuugou727/hexo-theme-artemis-night" target="_blank">Artemis Night</a>.</p></div></footer></div><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-104625762-1']);
_gaq.push(['_trackPageview']);

(function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>